<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover" />
  <title>LemonGBA</title>
  <style>
    :root { 
      /* Indigo Theme */
      --bg: #1a1b26; 
      --gba-body: #3b355a; 
      --gba-bezel: #5c5870;
      --screen-lens: #18181b;
      --led-on: #bfff00;
      
      /* Controls */
      --dpad: #2d2d30;
      --btn-ab: #dfe0e6; 
      --btn-shoulder: #d6d6da;
      --btn-start: #787880;
      
      --text: #e8f0ff; 
      --glass: rgba(255, 255, 255, 0.1);
    }

    html, body {
      margin: 0;
      background: var(--bg);
      height: 100dvh;
      width: 100vw;
      overflow: hidden;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      color: var(--text);
      touch-action: none;
      user-select: none;
      -webkit-user-select: none;
      display: flex;
      flex-direction: column;
    }

    /* === HEADER / FILE LOAD === */
    .top-bar {
      height: 50px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0 20px;
      background: rgba(0,0,0,0.3);
      z-index: 20;
    }
    .brand { font-weight: 800; letter-spacing: -1px; color: #fff; font-size: 18px; }
    .brand span { color: #8179b5; }
    
    .header-icons { display: flex; gap: 15px; }
    .icon-btn {
      width: 36px; height: 36px;
      border-radius: 50%;
      background: var(--glass);
      display: flex; align-items: center; justify-content: center;
      cursor: pointer;
    }

    /* === MAIN CONSOLE AREA === */
    .console-wrapper {
      flex: 1;
      position: relative;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      padding-top: 10px;
    }

    /* Screen Bezel Area */
    .screen-housing {
      background: var(--gba-bezel);
      /* Adjusted padding to be symmetrical since logo is gone */
      padding: 20px; 
      border-radius: 10px 10px 40px 40px;
      width: 90vw;
      max-width: 400px;
      box-shadow: 0 10px 20px rgba(0,0,0,0.4);
      position: relative;
      display: flex;
      flex-direction: column;
      align-items: center;
      z-index: 5;
    }

    .screen-lens {
      background: var(--screen-lens);
      padding: 15px 25px;
      border-radius: 8px 8px 25px 25px;
      width: 100%;
      box-sizing: border-box;
      display: flex;
      justify-content: center;
      position: relative;
    }

    .power-led {
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      left: 8px;
      width: 6px; height: 6px;
      background: #333;
      border-radius: 50%;
      box-shadow: inset 0 1px 3px rgba(0,0,0,0.5);
    }
    .power-led.on { background: var(--led-on); box-shadow: 0 0 8px var(--led-on); }

    /* The actual Canvas */
    canvas {
      background: #000;
      image-rendering: pixelated;
      width: 100%;
      aspect-ratio: 3/2;
      box-shadow: inset 0 0 10px rgba(0,0,0,0.8);
    }

    /* === CONTROLS LAYER === */
    .controls-layer {
      flex: 1;
      width: 100%;
      max-width: 500px;
      position: relative;
      margin-top: 20px;
    }

    /* Generic Button Styling */
    .v-btn {
      position: absolute;
      cursor: pointer;
      box-shadow: 0 4px 0 rgba(0,0,0,0.3), 0 5px 10px rgba(0,0,0,0.3);
      transition: transform 0.05s, box-shadow 0.05s;
      z-index: 10;
    }
    .v-btn.active {
      transform: translateY(3px);
      box-shadow: 0 1px 0 rgba(0,0,0,0.3), inset 0 2px 5px rgba(0,0,0,0.4);
    }

    /* D-PAD */
    .dpad-container {
      position: absolute;
      bottom: 80px;
      left: 30px;
      width: 120px;
      height: 120px;
    }
    .dpad-cross {
      width: 100%; height: 100%;
      position: relative;
    }
    /* Invisible touch targets for D-pad */
    .dpad-hitbox {
      position: absolute;
    }
    .hit-u { top: 0; left: 33%; width: 34%; height: 33%; }
    .hit-d { bottom: 0; left: 33%; width: 34%; height: 33%; }
    .hit-l { top: 33%; left: 0; width: 33%; height: 34%; }
    .hit-r { top: 33%; right: 0; width: 33%; height: 34%; }

    /* Visual D-Pad Parts */
    .d-visual {
      position: absolute;
      background: var(--dpad);
      border-radius: 4px;
      pointer-events: none;
    }
    .d-h { top: 38%; left: 0; width: 100%; height: 24%; border-radius: 4px;}
    .d-v { left: 38%; top: 0; height: 100%; width: 24%; border-radius: 4px;}
    .d-center { top: 38%; left: 38%; width: 24%; height: 24%; background: var(--dpad); z-index: 2; }
    
    .d-visual::after { content:''; display: block; width: 100%; height: 100%; background: transparent; transition: 0.1s; }
    .hit-u.active ~ .d-v::after { background: linear-gradient(to top, transparent, rgba(255,255,255,0.2)); }
    .hit-d.active ~ .d-v::after { background: linear-gradient(to bottom, transparent, rgba(255,255,255,0.2)); }
    .hit-l.active ~ .d-h::after { background: linear-gradient(to left, transparent, rgba(255,255,255,0.2)); }
    .hit-r.active ~ .d-h::after { background: linear-gradient(to right, transparent, rgba(255,255,255,0.2)); }

    /* A/B Buttons */
    .ab-container {
      position: absolute;
      bottom: 80px;
      right: 30px;
      width: 130px;
      height: 120px;
    }
    .btn-round {
      width: 48px; height: 48px;
      border-radius: 50%;
      background: var(--btn-ab);
      display: flex; align-items: center; justify-content: center;
      font-weight: 800; color: rgba(0,0,0,0.3);
      font-size: 18px;
    }
    .btn-a { top: 10px; right: 0; background: #d0d1d6;}
    .btn-b { top: 40px; right: 60px; background: #d0d1d6;}

    /* Start/Select */
    .menu-container {
      position: absolute;
      bottom: 20px;
      width: 100%;
      display: flex;
      justify-content: center;
      gap: 15px;
    }
    .btn-pill {
      width: 60px; height: 22px;
      border-radius: 20px;
      background: var(--btn-start);
      transform: rotate(-15deg);
      border: none;
      box-shadow: 0 2px 5px rgba(0,0,0,0.5);
      font-size: 10px; color: rgba(255,255,255,0.5);
      display: flex; align-items: center; justify-content: center;
      font-weight: 700;
      letter-spacing: 1px;
    }

    /* Shoulders (L/R) */
    .shoulder-container {
      position: fixed;
      top: 55px; 
      width: 100%;
      display: flex;
      justify-content: space-between;
      padding: 0 10px;
      box-sizing: border-box;
      pointer-events: none; 
      z-index: 15;
    }
    .btn-shoulder {
      pointer-events: auto;
      width: 100px;
      height: 40px;
      background: var(--btn-shoulder);
      border-radius: 8px;
      border-bottom: 4px solid rgba(0,0,0,0.2);
      display: flex; align-items: center; justify-content: center;
      font-weight: bold; color: #555;
    }

    /* Landscape Mode */
    @media (orientation: landscape) {
      body { flex-direction: row; align-items: center; justify-content: center; }
      .top-bar { position: fixed; top: 0; left: 0; width: 100%; background: transparent; pointer-events: none; }
      .top-bar * { pointer-events: auto; }
      
      .console-wrapper { max-width: none; width: 100%; height: 100%; justify-content: center; }
      .screen-housing { width: auto; height: 85vh; aspect-ratio: 1.2; justify-content: center; padding: 20px; border-radius: 20px;}
      .screen-lens { height: 100%; align-items: center; padding: 40px; }
      
      .controls-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; max-width: none; margin: 0; pointer-events: none; }
      
      .dpad-container { bottom: 20px; left: 40px; width: 160px; height: 160px; pointer-events: auto; }
      .ab-container { bottom: 20px; right: 40px; width: 180px; height: 160px; pointer-events: auto; }
      .btn-round { width: 60px; height: 60px; font-size: 24px; }
      .btn-a { right: 10px; top: 30px; }
      .btn-b { right: 80px; top: 70px; }

      .menu-container { bottom: 10px; pointer-events: auto; }
      .shoulder-container { top: unset; bottom: 200px; padding: 0 40px; }
    }
  </style>
</head>
<body>

  <div class="top-bar">
    <div class="brand"></div>
    <div class="header-icons">
      <label class="icon-btn" title="Load ROM">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="2"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2-2z"></path></svg>
        <input type="file" id="romInput" style="display:none" accept=".gba,.gbc,.gb,.zip">
      </label>
      <div class="icon-btn" onclick="Module.requestFullScreen(true, false)">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="2"><path d="M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3M3 16v3a2 2 0 0 0 2 2h3"></path></svg>
      </div>
    </div>
  </div>

  <div class="console-wrapper">
    <div class="screen-housing">
      <div class="screen-lens">
        <div class="power-led" id="powerLed"></div>
        <canvas id="canvas" tabindex="1" oncontextmenu="event.preventDefault()"></canvas>
      </div>
    </div>

    <div class="controls-layer" id="ctrlLayer">
      
      <div class="shoulder-container">
        <div class="v-btn btn-shoulder input-btn" data-key="81">L</div>
        <div class="v-btn btn-shoulder input-btn" data-key="87">R</div>
      </div>

      <div class="dpad-container">
        <div class="d-visual d-h"></div>
        <div class="d-visual d-v"></div>
        <div class="d-visual d-center"></div>
        <div class="dpad-hitbox hit-u input-btn" data-key="38"></div>
        <div class="dpad-hitbox hit-d input-btn" data-key="40"></div>
        <div class="dpad-hitbox hit-l input-btn" data-key="37"></div>
        <div class="dpad-hitbox hit-r input-btn" data-key="39"></div>
      </div>

      <div class="menu-container">
        <div class="v-btn btn-pill input-btn" data-key="16">SELECT</div>
        <div class="v-btn btn-pill input-btn" data-key="13">START</div>
      </div>

      <div class="ab-container">
        <div class="v-btn btn-round btn-b input-btn" data-key="90">B</div>
        <div class="v-btn btn-round btn-a input-btn" data-key="88">A</div>
      </div>

    </div>
  </div>

<script>
  window.Module = {
    noInitialRun: true,
    canvas: document.getElementById('canvas'),
    print: (text) => console.log(text),
    printErr: (text) => console.error(text),
    locateFile: (path) => path.endsWith('.wasm') ? 'mgba_libretro.wasm' : path,
    onRuntimeInitialized: function() {
      console.log("Core Ready.");
      document.getElementById('powerLed').classList.add('on');
    }
  };

  document.getElementById('romInput').addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = function(event) {
      const data = new Uint8Array(event.target.result);
      if (Module.FS) {
        try {
          Module.FS.writeFile('/game.gba', data);
          if (window.SDL2?.audioContext) SDL2.audioContext.resume();
          Module.callMain(['/game.gba']);
          Module.canvas.focus();
        } catch(err) { console.error(err); }
      }
    };
    reader.readAsArrayBuffer(file);
  });

  /* TOUCH CONTROLLER */
  const keyMap = {
    "38": { k: "ArrowUp", c: "ArrowUp" },
    "40": { k: "ArrowDown", c: "ArrowDown" },
    "37": { k: "ArrowLeft", c: "ArrowLeft" },
    "39": { k: "ArrowRight", c: "ArrowRight" },
    "88": { k: "x", c: "KeyX" },      
    "90": { k: "z", c: "KeyZ" },      
    "81": { k: "q", c: "KeyQ" },      
    "87": { k: "w", c: "KeyW" },      
    "13": { k: "Enter", c: "Enter" }, 
    "16": { k: "Shift", c: "ShiftLeft" } 
  };

  const activeTouches = new Map(); 

  function triggerKey(element, type) {
    if (!element) return;
    const code = element.getAttribute('data-key');
    if (!code || !keyMap[code]) return;
    
    if (type === 'keydown') element.classList.add('active');
    else element.classList.remove('active');

    const event = new KeyboardEvent(type, {
      key: keyMap[code].k,
      code: keyMap[code].c,
      keyCode: parseInt(code),
      which: parseInt(code),
      bubbles: true
    });
    window.dispatchEvent(event);
    if(Module.canvas) Module.canvas.dispatchEvent(event);
  }

  const ctrlLayer = document.getElementById('ctrlLayer');

  const handleTouch = (e) => {
    e.preventDefault(); 
    const changedTouches = e.changedTouches;

    for (let i = 0; i < changedTouches.length; i++) {
      const touch = changedTouches[i];
      const target = document.elementFromPoint(touch.clientX, touch.clientY);
      const btn = target ? target.closest('.input-btn') : null;

      if (e.type === 'touchstart') {
        if (btn) {
          activeTouches.set(touch.identifier, btn);
          triggerKey(btn, 'keydown');
          if(navigator.vibrate) navigator.vibrate(10);
        }
      } 
      else if (e.type === 'touchmove') {
        const prevBtn = activeTouches.get(touch.identifier);
        
        if (prevBtn && prevBtn !== btn) {
          triggerKey(prevBtn, 'keyup');
          activeTouches.delete(touch.identifier);
        }
        
        if (btn && prevBtn !== btn) {
          activeTouches.set(touch.identifier, btn);
          triggerKey(btn, 'keydown');
          if(navigator.vibrate) navigator.vibrate(10);
        }
      } 
      else if (e.type === 'touchend' || e.type === 'touchcancel') {
        const prevBtn = activeTouches.get(touch.identifier);
        if (prevBtn) {
          triggerKey(prevBtn, 'keyup');
          activeTouches.delete(touch.identifier);
        }
      }
    }
  };

  ctrlLayer.addEventListener('touchstart', handleTouch, { passive: false });
  ctrlLayer.addEventListener('touchmove', handleTouch, { passive: false });
  ctrlLayer.addEventListener('touchend', handleTouch, { passive: false });
  ctrlLayer.addEventListener('touchcancel', handleTouch, { passive: false });

</script>
<script type="module">
  import createModule from './mgba_libretro.js';
  createModule(window.Module).then((instance) => {
    Object.assign(window.Module, instance);
    console.log("WASM Loaded");
  });
</script>
</body>
</html>
