<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover" />
  <title>LemonGBA</title>
  <style>
    :root { 
      /* Minimalist Dark Palette */
      --bg: #0a0a0a; 
      --ui-accent: #222;
      --screen-border: #1a1a1a;
      --text: #ffffff;
      
      /* Neutral Controls */
      --ctrl-bg: #1e1e1e;
      --ctrl-active: #333;
      --ctrl-text: #888;
      
      --glass: rgba(255, 255, 255, 0.05);
      --glass-border: rgba(255, 255, 255, 0.1);
    }

    html, body {
      margin: 0;
      background: var(--bg);
      height: 100dvh;
      width: 100vw;
      overflow: hidden;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      color: var(--text);
      touch-action: none;
      user-select: none;
      -webkit-user-select: none;
      display: flex;
      flex-direction: column;
    }

    /* === UI HEADER === */
    .top-bar {
      height: 60px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0 20px;
      z-index: 20;
    }
    .brand { font-weight: 700; font-size: 16px; letter-spacing: 2px; text-transform: uppercase; }
    
    .header-icons { display: flex; gap: 12px; }
    .icon-btn {
      width: 40px; height: 40px;
      border-radius: 8px;
      background: var(--glass);
      display: flex; align-items: center; justify-content: center;
      cursor: pointer;
      border: 1px solid var(--glass-border);
    }

    /* === CONSOLE AREA === */
    .console-wrapper {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }

    .screen-housing {
      background: var(--screen-border);
      padding: 10px;
      border-radius: 12px;
      width: 90vw;
      max-width: 450px;
      box-shadow: 0 20px 50px rgba(0,0,0,0.5);
    }

    canvas {
      background: #000;
      image-rendering: pixelated;
      width: 100%;
      aspect-ratio: 3/2;
      display: block;
      border-radius: 4px;
    }

    /* === CONTROLS === */
    .controls-layer {
      flex: 1;
      width: 100%;
      max-width: 500px;
      position: relative;
    }

    .touch-btn {
      position: absolute;
      background: var(--ctrl-bg);
      color: var(--ctrl-text);
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background 0.1s, transform 0.05s;
      border: 1px solid var(--glass-border);
    }
    .touch-btn:active, .touch-btn.active { 
      background: var(--ctrl-active); 
      transform: scale(0.95);
      color: #fff;
    }

    /* D-PAD */
    .dpad-container {
      position: absolute;
      bottom: 60px;
      left: 20px;
      width: 140px; height: 140px;
    }
    .d-btn { width: 45px; height: 45px; border-radius: 8px; }
    .d-btn.up    { top: 0; left: 47px; }
    .d-btn.down  { bottom: 0; left: 47px; }
    .d-btn.left  { left: 0; top: 47px; }
    .d-btn.right { right: 0; top: 47px; }

    /* A/B Buttons */
    .ab-container {
      position: absolute;
      bottom: 60px;
      right: 20px;
      width: 140px; height: 120px;
    }
    .btn-circle {
      width: 60px; height: 60px;
      border-radius: 50%;
      font-weight: bold;
      font-size: 18px;
    }
    .btn-a { right: 0; top: 0; }
    .btn-b { left: 0; bottom: 10px; }

    /* Shoulders */
    .shoulder-container {
      position: absolute;
      top: 0; width: 100%;
      display: flex; justify-content: space-between;
      padding: 0 20px; box-sizing: border-box;
    }
    .btn-shoulder {
      width: 80px; height: 40px;
      border-radius: 4px;
      font-size: 12px; font-weight: bold;
    }

    /* Start / Select */
    .menu-container {
      position: absolute;
      bottom: 20px;
      width: 100%;
      display: flex;
      justify-content: center;
      gap: 20px;
    }
    .btn-pill {
      width: 70px; height: 25px;
      border-radius: 4px;
      font-size: 9px; letter-spacing: 1px;
    }

    @media (orientation: landscape) {
      .screen-housing { height: 75vh; width: auto; aspect-ratio: 3/2; }
      .controls-layer { position: fixed; top: 0; left: 0; width: 100%; height: 100%; max-width: none; pointer-events: none; }
      .touch-btn { pointer-events: auto; }
      .shoulder-container { top: 70px; }
    }
  </style>
</head>
<body>

  <div class="top-bar">
    <div class="brand">Lemon</div>
    <div class="header-icons">
      <label class="icon-btn">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4M17 8l-5-5-5 5M12 3v12"/></svg>
        <input type="file" id="romInput" style="display:none" accept=".gba,.gbc,.gb,.zip">
      </label>
      <div class="icon-btn" onclick="Module.requestFullScreen(true, false)">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M15 3h6v6M9 21H3v-6M21 3l-7 7M3 21l7-7"/></svg>
      </div>
    </div>
  </div>

  <div class="console-wrapper">
    <div class="screen-housing">
      <canvas id="canvas" tabindex="1"></canvas>
    </div>

    <div class="controls-layer">
      <div class="shoulder-container">
        <div class="touch-btn btn-shoulder" data-key="81">L</div>
        <div class="touch-btn btn-shoulder" data-key="87">R</div>
      </div>

      <div class="dpad-container">
        <div class="touch-btn d-btn up" data-key="38">↑</div>
        <div class="touch-btn d-btn down" data-key="40">↓</div>
        <div class="touch-btn d-btn left" data-key="37">←</div>
        <div class="touch-btn d-btn right" data-key="39">→</div>
      </div>

      <div class="ab-container">
        <div class="touch-btn btn-circle btn-b" data-key="90">B</div>
        <div class="touch-btn btn-circle btn-a" data-key="88">A</div>
      </div>

      <div class="menu-container">
        <div class="touch-btn btn-pill" data-key="16">SELECT</div>
        <div class="touch-btn btn-pill" data-key="13">START</div>
      </div>
    </div>
  </div>

<script>
  window.Module = {
    noInitialRun: true,
    canvas: document.getElementById('canvas'),
    locateFile: (path) => path.endsWith('.wasm') ? 'mgba_libretro.wasm' : path
  };

  document.getElementById('romInput').addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = function(event) {
      const data = new Uint8Array(event.target.result);
      if (Module.FS) {
        Module.FS.writeFile('/game.gba', data);
        if (window.SDL2?.audioContext) SDL2.audioContext.resume();
        Module.callMain(['/game.gba']);
        Module.canvas.focus();
      }
    };
    reader.readAsArrayBuffer(file);
  });

  const keyMap = {
    "38": { k: "ArrowUp", c: "ArrowUp" },
    "40": { k: "ArrowDown", c: "ArrowDown" },
    "37": { k: "ArrowLeft", c: "ArrowLeft" },
    "39": { k: "ArrowRight", c: "ArrowRight" },
    "88": { k: "x", c: "KeyX" },      
    "90": { k: "z", c: "KeyZ" },      
    "81": { k: "q", c: "KeyQ" },      
    "87": { k: "w", c: "KeyW" },      
    "13": { k: "Enter", c: "Enter" }, 
    "16": { k: "Shift", c: "ShiftLeft" } 
  };

  function sendKey(code, type) {
    const data = keyMap[code];
    if (!data) return;
    const ev = new KeyboardEvent(type, {
      key: data.k, code: data.c, keyCode: parseInt(code), which: parseInt(code), bubbles: true
    });
    window.dispatchEvent(ev);
    Module.canvas?.dispatchEvent(ev);
  }

  document.querySelectorAll('.touch-btn').forEach(btn => {
    const code = btn.dataset.key;
    const start = (e) => {
      e.preventDefault();
      btn.classList.add('active');
      if (navigator.vibrate) navigator.vibrate(10);
      sendKey(code, 'keydown');
    };
    const end = (e) => {
      e.preventDefault();
      btn.classList.remove('active');
      sendKey(code, 'keyup');
    };
    btn.addEventListener('touchstart', start, {passive: false});
    btn.addEventListener('touchend', end, {passive: false});
    btn.addEventListener('mousedown', start);
    btn.addEventListener('mouseup', end);
  });
</script>

<script type="module">
  import createModule from './mgba_libretro.js';
  createModule(window.Module).then(instance => Object.assign(window.Module, instance));
</script>
</body>
</html>
